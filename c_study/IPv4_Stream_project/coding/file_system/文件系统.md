# 文件系统

实现 ls 的功能，myls -l -a -i -n

## 1、目录和文件

- 获取文件属性

```c
// 获取文件相关属性的函数
#include <sys/types.h>
#include <sys/stat.h>
#include <unistd.h>

int stat(const char *pathname, struct stat *statbuf);// 通过文件路径获取属性
int fstat(int fd, struct stat *statbuf); // 通过文件描述符获取属性
int lstat(const char *pathname, struct stat *statbuf); // 面对符号链接文件时获取的是符号链接文件的属性
```

- 文件类型：dcb-lsp，文件夹，字符设备，块设备文件，普通文件，链接文件，socket 文件，命名管道文件

```c
filestat.st_mode & S_IFMT;

S_ISREG(m)  is it a regular file?

S_ISDIR(m)  directory?

S_ISCHR(m)  character device?

S_ISBLK(m)  block device?

S_ISFIFO(m) FIFO (named pipe)?

S_ISLNK(m)  symbolic link?  (Not in POSIX.1-1996.)

S_ISSOCK(m) socket?  (Not in POSIX.1-1996.)
```

- 文件访问权限
- umask
  创建的新文件的默认权限为 0666 & ~umask，作用：防止出现文件权限过松
  chmod 修改文件的 user group other 的权限。

- 文件权限的更改、管理

```c
#include <sys/stat.h>

int chmod(const char *pathname, mode_t mode);
int fchmod(int fd, mode_t mode);
```

- 粘住位(t 位)：给常用的目录或者二进制文件设置 t 位

- 文件系统：FAT、UFS
  作用： 文件或者数据的存储和管理
  文件名存在于目录文件中，目录文件存在于当前路径下，目录文件中存储了 inode 和 文件名 的对应关系即目录项(inode 文件名)

- 硬链接，符号链接
  硬链接 ln src_file dest_file，如 ln bigfile bigfile_link 给 bigfile 创建硬链接 bigfile_link, 两个文件的 inode 号相同，即目录项的同义词，删除原文件后硬链接依然存在；
  符号链接，相当于创建快捷方式，ln -s src_file dest_file；
  区别：硬链接与目录项是同义词，并且建立硬链接有限制，不能给分区建立，不能给目录建立；符号链接可以跨分区，给目录建立符号链接

```c
#include <unistd.h>
int link(const char *oldpath, const char *newpath);
int unlink(const char *pathname);

#include <stdio.h>
int remove(const char *pathname);

#include <stdio.h>
int rename(const char *oldpath, const char *newpath);
```

- utime

```c
#include <sys/types.h>
#include <utime.h>

struct utimbuf {
    time_t actime;       /* access time */
    time_t modtime;      /* modification time */
};
int utime(const char *filename, const struct utimbuf *times);
```

- 目录的创建和销毁

```c
mkdir();
rmdir();
```

- 更改当前工作路径

```c
chdir();
fchdir();
getcwd();
```

- 分析目录、读取目录内容

```c
#include <glob.h>

typedef struct {
               size_t   gl_pathc;    /* Count of paths matched so far  */
               char   **gl_pathv;    /* List of matched pathnames.  */
               size_t   gl_offs;     /* Slots to reserve in gl_pathv.  */
           } glob_t;

gl_pathc; 和 **gl_pathv; 与 argc **argv相似

int glob(const char *pattern, // 通配符
        int flags, // 特殊要求
        int (*errfunc) (const char *epath, int eerrno), //
        glob_t *pglob);
```

- opendir(); closedir(); readdir(); rewinddir(); seekdir(); telldir();

## 2、系统数据文件和信息

- 相关文件 /etc/passwd; /etc/group; /etc/shadow; 时间戳

## 3、进程环境
